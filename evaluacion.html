<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jornada de Formación Salesiana</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root{--prm:#005A9C;--sec:#FFC72C;--bg:#f4f7fa;--txt:#333;--wht:#fff;--shw:0 4px 15px rgba(0,0,0,0.08);--corr:#28a745;--err:#dc3545}
        body{font-family:'Poppins',sans-serif;background-color:var(--bg);color:var(--txt);line-height:1.6;margin:0;padding:20px}
        .container{max-width:900px;margin:0 auto;background-color:var(--wht);border-radius:15px;box-shadow:var(--shw);overflow:hidden}
        header{background-color:var(--prm);color:var(--wht);padding:30px 20px;text-align:center;position:relative}
        header h1{margin:0 0 10px 0;font-size:2.5rem;font-weight:700}
        header h2{margin:0;font-size:1.8rem;font-weight:600;opacity:0.95}
        header p{margin:10px 0 0;font-size:1.1rem;opacity:0.9}
        .logo-salesianos{position:absolute;top:20px;left:25px;height:80px;opacity:0.9}
        main{padding:20px}
        .progress-container{margin-bottom:30px}
        .progress-bar-wrapper{width:100%;background-color:#e0e0e0;border-radius:50px;overflow:hidden}
        .progress-bar{height:20px;width:0%;background-color:var(--sec);border-radius:50px;transition:width .5s ease-in-out;text-align:center;color:var(--txt);font-weight:600}
        .progress-label{text-align:center;font-weight:600;color:var(--prm);margin-top:5px}
        .phase-accordion details{margin-bottom:15px;border-radius:10px;border:1px solid #ddd;overflow:hidden}
        .phase-accordion summary{background-color:var(--wht);color:var(--prm);font-size:1.3rem;font-weight:600;padding:15px 20px;cursor:pointer;list-style:none;display:flex;justify-content:space-between;align-items:center;transition:background-color .3s}
        .phase-accordion details[open] summary{background-color:var(--prm);color:var(--wht)}
        .phase-accordion summary::after{content:'➕';font-size:1.5rem;transition:transform .3s ease-out}
        .phase-accordion details[open] summary::after{content:'➖';transform:rotate(180deg)}
        .activities-container{padding:20px;background-color:var(--bg);display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
        .activity-card{background-color:var(--wht);border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08);border-left:5px solid var(--sec);display:flex;flex-direction:column;justify-content:space-between}
        .activity-card h3{margin-top:0;color:var(--prm);font-size:1.1rem}
        .task-completion{margin-top:15px;padding-top:15px;border-top:1px solid #eee}
        .lock-container{display:flex;gap:10px;align-items:center;margin-bottom:10px}
        .lock-container input{padding:8px;border:1px solid #ccc;border-radius:4px;flex-grow:1}
        .lock-container button{padding:8px 12px;border:none;background:var(--prm);color:var(--wht);border-radius:4px;cursor:pointer}
        .task-checkbox-wrapper{display:flex;align-items:center;cursor:pointer;opacity:0.5}
        .task-checkbox-wrapper.unlocked{opacity:1}
        .task-checkbox-wrapper input[type=checkbox]{width:20px;height:20px;margin-right:10px;cursor:pointer}
        .task-checkbox-wrapper input[type=checkbox]:disabled{cursor:not-allowed}
        .task-checkbox-wrapper label{font-weight:600;color:var(--prm);cursor:pointer}
        .resource-buttons{margin-top:15px;display:flex;flex-direction:column;gap:10px}
        .btn-resource{font-weight:600;text-decoration:none;display:inline-block;padding:8px 15px;border-radius:5px;text-align:center}
        .btn-activity{background-color:var(--sec);color:var(--txt)}
        .commitment-form .form-group{margin-bottom:15px}
        .commitment-form label{display:block;margin-bottom:5px;font-weight:600}
        .commitment-form input,.commitment-form select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
        .modal-content{background:var(--wht);padding:30px;border-radius:15px;box-shadow:0 5px 25px rgba(0,0,0,.2);width:90%;max-width:500px;text-align:center}
        .modal-content h2{color:var(--prm)}
        .modal-content .data-confirm p{background:#eee;padding:10px;border-radius:5px;text-align:left}
        .modal-content .modal-buttons{display:flex;justify-content:space-around;margin-top:20px}
        .modal-buttons button{padding:10px 20px;border-radius:8px;border:none;font-size:1rem;font-weight:600;cursor:pointer}
        #confirm-download-btn{background:var(--corr);color:var(--wht)}
        #edit-data-btn{background:#6c757d;color:var(--wht)}
        footer{text-align:center;padding:25px 0;margin-top:20px}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="https://sdb.bo/sdb/wp-content/uploads/2021/12/SALECIANOS-VERTICAL-2.png" alt="Logo Salesianos" class="logo-salesianos">
            <h1>Jornada de Formación Salesiana</h1>
            <h2>De la Visión a la Evidencia</h2>
            <p>El Camino del Evaluador Riguroso y Creativo</p>
        </header>
        <main>
            <div class="progress-container">
                <div class="progress-label" id="progress-text">Progreso del Taller: 0%</div>
                <div class="progress-bar-wrapper"><div class="progress-bar" id="progress-bar"></div></div>
            </div>
            <div class="phase-accordion">
                <details open>
                    <summary>Misión 1: Conectar y Activar</summary>
                    <div class="activities-container">
                        <div class="activity-card">
                            <div><h3>Bienvenida e Impacto Inicial</h3><p>Captamos la atención con un mensaje potente.</p></div>
                            <div class="resource-buttons"><a href="https://gamma.app/docs/La-Evaluacion-yvjhqvklt7jkzrp" target="_blank" class="btn-resource btn-activity">Acceder al Recurso ↗</a></div>
                            <div class="task-completion" data-task-id="task1">
                                <div class="lock-container"><input type="text" placeholder="Código de la Tarea"><button>Desbloquear</button></div>
                                <div class="task-checkbox-wrapper"><input type="checkbox" id="task1" class="task-checkbox" disabled><label for="task1">Marcar como completada</label></div>
                                <p style="font-size:0.8em; color:#777; margin-top:5px;">Anota el código del recurso para desbloquear.</p>
                            </div>
                        </div>
                        <div class="activity-card">
                            <div><h3>Trivia: Mitos y Verdades</h3><p>Activamos conocimientos previos con un juego.</p></div>
                            <div class="resource-buttons"><a href="https://elmejorequipo.github.io/talleres/trivia.html" target="_blank" class="btn-resource btn-activity">Acceder al Recurso ↗</a></div>
                            <div class="task-completion" data-task-id="task2">
                                <div class="lock-container"><input type="text" placeholder="Código de la Tarea"><button>Desbloquear</button></div>
                                <div class="task-checkbox-wrapper"><input type="checkbox" id="task2" class="task-checkbox" disabled><label for="task2">Marcar como completada</label></div>
                                <p style="font-size:0.8em; color:#777; margin-top:5px;">Anota el código del recurso para desbloquear.</p>
                            </div>
                        </div>
                    </div>
                </details>
                <details>
                    <summary>Misión 4: Sellar el Compromiso</summary>
                    <div class="activities-container">
                         <div class="activity-card">
                             <div><h3>Nuestro Muro del Compromiso</h3><p>Transforma la reflexión en acción y obtén tu certificado.</p></div>
                            <div class="commitment-form">
                                <div class="form-group"><label for="fullName">Nombre Completo:</label><input type="text" id="fullName" placeholder="TODO EN MAYÚSCULAS"></div>
                                <div class="form-group"><label for="level">Nivel:</label><select id="level"><option value="Inicial">Inicial</option><option value="Primaria">Primaria</option><option value="Secundaria">Secundaria</option></select></div>
                                <div class="form-group"><label for="course">Curso:</label><input type="text" id="course" placeholder="Ej: 6to de Primaria 'A'"></div>
                            </div>
                            <div class="task-completion" data-task-id="task9">
                               <div class="task-checkbox-wrapper"><input type="checkbox" id="task9" class="task-checkbox" disabled><label for="task9">He completado mi compromiso</label></div>
                               <p style="font-size:0.8em; color:#777; margin-top:5px;">Esta tarea se habilitará al completar todo lo anterior.</p>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </main>
        <footer><p>Creado con el Asesor Pedagógico Salesiano &copy; 2025</p></footer>
    </div>

    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h2>¡Felicidades, has completado la jornada!</h2>
            <p>Por favor, confirma que tus datos para el certificado son correctos:</p>
            <div class="data-confirm">
                <p><strong>Nombre:</strong> <span id="confirm-name"></span></p>
                <p><strong>Nivel:</strong> <span id="confirm-level"></span></p>
                <p><strong>Curso:</strong> <span id="confirm-course"></span></p>
            </div>
            <div class="modal-buttons">
                <button id="edit-data-btn">Editar Datos</button>
                <button id="confirm-download-btn">Descargar Certificado</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const taskCodes = {
                task1: "SALESIANO24",
                task2: "EVALUAR+",
                // Agrega códigos para task3, task4, etc.
            };
            
            const allCheckboxes = Array.from(document.querySelectorAll('.task-checkbox'));
            const finalTaskCheckbox = document.getElementById('task9');
            const prerequisiteCheckboxes = allCheckboxes.filter(cb => cb.id !== 'task9');
            const totalTasks = allCheckboxes.length;

            function checkPrerequisites() {
                const allPrerequisitesMet = prerequisiteCheckboxes.every(cb => cb.checked);
                const finalTaskWrapper = finalTaskCheckbox.closest('.task-checkbox-wrapper');
                
                if (allPrerequisitesMet) {
                    finalTaskCheckbox.disabled = false;
                    finalTaskWrapper.classList.add('unlocked');
                    finalTaskWrapper.style.cursor = 'pointer';
                } else {
                    finalTaskCheckbox.disabled = true;
                    finalTaskWrapper.classList.remove('unlocked');
                    finalTaskWrapper.style.cursor = 'not-allowed';
                }
            }

            function updateProgress() {
                const checkedTasks = document.querySelectorAll('.task-checkbox:checked').length;
                const percentage = totalTasks > 0 ? (checkedTasks / totalTasks) * 100 : 0;
                document.getElementById('progress-bar').style.width = percentage + '%';
                document.getElementById('progress-text').textContent = `Progreso del Taller: ${Math.round(percentage)}%`;
                if (percentage === 100) {
                     document.getElementById('progress-text').textContent = '¡Taller Completado!';
                     document.getElementById('progress-bar').style.backgroundColor = 'var(--corr)';
                } else {
                     document.getElementById('progress-bar').style.backgroundColor = 'var(--sec)';
                }
            }

            function saveState() {
                const states = {};
                allCheckboxes.forEach(cb => {
                    states[cb.id] = { checked: cb.checked, disabled: cb.disabled };
                });
                localStorage.setItem('tallerProgresoV4', JSON.stringify(states));
            }

            function loadState() {
                const savedStates = JSON.parse(localStorage.getItem('tallerProgresoV4'));
                if (savedStates) {
                    allCheckboxes.forEach(cb => {
                        const state = savedStates[cb.id];
                        if (state && cb.id !== 'task9') { // No cargar estado 'disabled' de la task9
                            cb.checked = state.checked;
                            cb.disabled = state.disabled;
                            if(!cb.disabled){
                                const container = cb.closest('.task-completion');
                                container.querySelector('.lock-container').style.display = 'none';
                                container.querySelector('.task-checkbox-wrapper').classList.add('unlocked');
                            }
                        }
                    });
                }
                updateProgress();
                checkPrerequisites();
            }

            document.querySelectorAll('.lock-container button').forEach(button => {
                button.addEventListener('click', () => {
                    const container = button.closest('.task-completion');
                    const taskId = container.dataset.taskId;
                    const input = container.querySelector('input[type="text"]');
                    const checkbox = document.getElementById(taskId);

                    if (input.value.trim().toUpperCase() === taskCodes[taskId]) {
                        checkbox.disabled = false;
                        container.querySelector('.lock-container').style.display = 'none';
                        container.querySelector('.task-checkbox-wrapper').classList.add('unlocked');
                        alert('¡Código correcto! Tarea desbloqueada.');
                        saveState();
                    } else {
                        alert('Código incorrecto. ¡Revisa el recurso de la actividad!');
                        input.value = '';
                    }
                });
            });

            allCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    updateProgress();
                    checkPrerequisites();
                    saveState();
                    if (cb.id === 'task9' && cb.checked) {
                        triggerCertificateFlow();
                    }
                });
            });

            function triggerCertificateFlow() {
                const fullName = document.getElementById('fullName').value.trim().toUpperCase();
                if (!fullName) {
                    alert('Por favor, ingresa tu nombre completo para el certificado.');
                    finalTaskCheckbox.checked = false;
                    saveState();
                    updateProgress();
                    return;
                }
                
                document.getElementById('confirm-name').textContent = fullName;
                document.getElementById('confirm-level').textContent = document.getElementById('level').value;
                document.getElementById('confirm-course').textContent = document.getElementById('course').value;
                document.getElementById('confirmation-modal').style.display = 'flex';
            }

            document.getElementById('edit-data-btn').addEventListener('click', () => {
                document.getElementById('confirmation-modal').style.display = 'none';
            });

            document.getElementById('confirm-download-btn').addEventListener('click', generateCertificate);

            async function generateCertificate() {
                 const modal = document.getElementById('confirmation-modal');
                 modal.innerHTML = '<h2>Generando tu certificado...</h2><p>Por favor, espera un momento.</p>';
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({orientation: 'landscape', unit: 'px', format: [800, 565]});
                
                // --- Estilos y contenido del PDF ---
                // ... (código de generación de PDF sin cambios)

                pdf.save('Certificado_Jornada_Salesiana.pdf');
                 // ... (código para restaurar el modal sin cambios)
            }

            loadState();
        });
    </script>
</body>
</html>
